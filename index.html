<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auto MPG Narrative Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    #buttons {
      margin: 20px;
    }
    svg {
      margin-top: 20px;
    }
    .annotation {
      font-size: 14px;
      fill: #333;
      font-style: italic;
    }
  </style>
</head>
<body>

  <h1>2017 Automobile Efficiency Story</h1>

  <div id="buttons">
    <button onclick="setScene(1)">Scene 1: MPG Overview</button>
    <button onclick="setScene(2)">Scene 2: Cylinders vs MPG</button>
    <button onclick="setScene(3)">Scene 3: Make Comparison</button>
  </div>

  <select id="makeSelector" style="display:none;" onchange="updateScene3()"></select>

  <div id="vis"></div>

  <script>
    const data = [
      { Make: "Acura", Fuel: "Gasoline", EngineCylinders: 4, AverageHighwayMPG: 35, AverageCityMPG: 25 },
      { Make: "Acura", Fuel: "Gasoline", EngineCylinders: 6, AverageHighwayMPG: 28, AverageCityMPG: 21 },
      { Make: "Alfa Romeo", Fuel: "Gasoline", EngineCylinders: 4, AverageHighwayMPG: 33, AverageCityMPG: 24 },
      { Make: "Alfa Romeo", Fuel: "Gasoline", EngineCylinders: 6, AverageHighwayMPG: 24, AverageCityMPG: 17 },
      { Make: "Aston Martin", Fuel: "Gasoline", EngineCylinders: 12, AverageHighwayMPG: 19, AverageCityMPG: 12 },
      { Make: "Audi", Fuel: "Gasoline", EngineCylinders: 4, AverageHighwayMPG: 30, AverageCityMPG: 23 },
      { Make: "Audi", Fuel: "Gasoline", EngineCylinders: 6, AverageHighwayMPG: 27, AverageCityMPG: 19 },
    ];

    let currentScene = 1;

    const width = 600, height = 400, margin = { top: 40, right: 40, bottom: 60, left: 60 };

    function setScene(sceneNumber) {
      currentScene = sceneNumber;
      d3.select("#vis").html(""); // clear chart
      d3.select("#makeSelector").style("display", sceneNumber === 3 ? "inline" : "none");
      if (sceneNumber === 1) drawScene1();
      else if (sceneNumber === 2) drawScene2();
      else if (sceneNumber === 3) drawScene3();
    }

    // Scene 1: MPG Overview
    function drawScene1() {
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const makes = Array.from(new Set(data.map(d => d.Make)));

      const mpgByMake = makes.map(make => {
        const entries = data.filter(d => d.Make === make);
        return {
          Make: make,
          Highway: d3.mean(entries, d => d.AverageHighwayMPG),
          City: d3.mean(entries, d => d.AverageCityMPG)
        };
      });

      const x = d3.scaleBand().domain(mpgByMake.map(d => d.Make)).range([margin.left, width - margin.right]).padding(0.2);
      const y = d3.scaleLinear().domain([0, d3.max(mpgByMake, d => d.Highway)]).nice().range([height - margin.bottom, margin.top]);

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      svg.selectAll(".bar")
        .data(mpgByMake)
        .join("rect")
        .attr("x", d => x(d.Make))
        .attr("y", d => y(d.Highway))
        .attr("width", x.bandwidth())
        .attr("height", d => y(0) - y(d.Highway))
        .attr("fill", "steelblue");

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("class", "annotation")
        .text("Most fuel-efficient makes in 2017 had smaller engines.");
    }

    // Scene 2: Cylinders vs MPG
    function drawScene2() {
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const x = d3.scaleLinear().domain([2, 14]).range([margin.left, width - margin.right]);
      const y = d3.scaleLinear().domain([10, 40]).range([height - margin.bottom, margin.top]);

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(6).tickFormat(d3.format("d")));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      svg.selectAll("circle")
        .data(data)
        .join("circle")
        .attr("cx", d => x(d.EngineCylinders))
        .attr("cy", d => y(d.AverageHighwayMPG))
        .attr("r", 5)
        .attr("fill", "orange");

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("class", "annotation")
        .text("Higher cylinder count tends to reduce highway efficiency.");
    }

    // Scene 3: MPG Comparison by Make
    function drawScene3() {
      const selector = d3.select("#makeSelector");
      selector.selectAll("option").data(Array.from(new Set(data.map(d => d.Make)))).join("option").text(d => d).attr("value", d => d);
      updateScene3();
    }

    function updateScene3() {
      d3.select("#vis").html("");
      const selectedMake = d3.select("#makeSelector").property("value");
      const filtered = data.filter(d => d.Make === selectedMake);

      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const mpgTypes = ["AverageCityMPG", "AverageHighwayMPG"];

      const x = d3.scaleBand().domain(mpgTypes).range([margin.left, width - margin.right]).padding(0.4);
      const y = d3.scaleLinear().domain([0, d3.max(filtered, d => Math.max(d.AverageCityMPG, d.AverageHighwayMPG))]).nice().range([height - margin.bottom, margin.top]);

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).tickFormat(d => d.replace("Average", "").replace("MPG", " MPG")));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      mpgTypes.forEach((mpgType, i) => {
        const avg = d3.mean(filtered, d => d[mpgType]);
        svg.append("rect")
          .attr("x", x(mpgType))
          .attr("y", y(avg))
          .attr("width", x.bandwidth())
          .attr("height", y(0) - y(avg))
          .attr("fill", mpgType.includes("City") ? "teal" : "purple");
      });

      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("class", "annotation")
        .text("City and highway MPG vary between models from the same manufacturer.");
    }

    // Initialize first scene
    setScene(1);
  </script>

</body>
</html>
 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2017 Auto MPG Narrative</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    #buttons {
      margin: 20px;
    }
    svg {
      margin-top: 20px;
    }
    .annotation {
      font-size: 14px;
      fill: #333;
      font-style: italic;
    }
  </style>
</head>
<body>

  <h1>2017 Automobile Efficiency Story</h1>

  <div id="buttons">
    <button onclick="setScene(1)">Scene 1: MPG Overview</button>
    <button onclick="setScene(2)">Scene 2: Cylinders vs MPG</button>
    <button onclick="setScene(3)">Scene 3: Make Comparison</button>
  </div>

  <select id="makeSelector" style="display:none;" onchange="updateScene3()"></select>

  <div id="vis"></div>

  <script>
    let data = [];
    const width = 1000, height = 600, margin = { top: 50, right: 180, bottom: 80, left: 80 };
    let currentScene = 1;

    d3.csv("cars2017.csv").then(function(loadedData) {
      data = loadedData;
    
      data.forEach(function(d) {
        d.AverageHighwayMPG = +d.AverageHighwayMPG;
        d.AverageCityMPG = +d.AverageCityMPG;
        d.EngineCylinders = +d.EngineCylinders;
      });
        
      populateMakeSelector();
      setScene(1);
    }).catch(function(error) {
      console.error("Error loading the CSV:", error);
    });

    function populateMakeSelector() {
      const selector = d3.select("#makeSelector");
      const makes = Array.from(new Set(data.map(d => d.Make))).sort();
      selector.selectAll("option")
        .data(makes)
        .join("option")
        .text(d => d)
        .attr("value", d => d);
    
      selector.property("value", makes[0]);
    }

    function setScene(sceneNumber) {
      currentScene = sceneNumber;
      d3.select("#vis").html("");
      d3.select("#makeSelector").style("display", sceneNumber === 3 ? "inline" : "none");
      if (sceneNumber === 1) drawScene1();
      else if (sceneNumber === 2) drawScene2();
      else if (sceneNumber === 3) drawScene3();
    }
    
    function drawScene1(data) {

      const mpgByCyl = d3.rollups(
        filteredData,
        v => ({
          city: d3.mean(v, d => d.AverageCityMPG),
          highway: d3.mean(v, d => d.AverageHighwayMPG)
        }),
        d => d.EngineCylinders
      );
    
      mpgByCyl.sort((a, b) => a[0] - b[0]);
    
      const chartData = [];
      mpgByCyl.forEach(([cyl, mpg]) => {
        chartData.push({ cyl, type: "City MPG", value: mpg.city });
        chartData.push({ cyl, type: "Highway MPG", value: mpg.highway });
      });
    
      const x0 = d3.scaleBand()
        .domain([...new Set(chartData.map(d => d.cyl))])
        .range([margin.left, width - margin.right])
        .paddingInner(0.2);
    
      const x1 = d3.scaleBand()
        .domain(["City MPG", "Highway MPG"])
        .range([0, x0.bandwidth()])
        .padding(0.1);
    
      const y = d3.scaleLinear()
        .domain([0, d3.max(chartData, d => d.value)]).nice()
        .range([height - margin.bottom, margin.top]);
    
      const color = d3.scaleOrdinal()
        .domain(["City MPG", "Highway MPG"])
        .range(["steelblue", "orange"]);
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x0).tickSizeOuter(0))
        .append("text")
        .attr("x", (width - margin.left - margin.right) / 2 + margin.left)
        .attr("y", 40)
        .attr("fill", "black")
        .attr("text-anchor", "middle")
        .text("Number of Cylinders");
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y))
        .append("text")
        .attr("x", -margin.left + 10)
        .attr("y", margin.top - 20)
        .attr("fill", "black")
        .attr("text-anchor", "start")
        .text("Miles per Gallon (MPG)");
    
      svg.append("g")
        .selectAll("g")
        .data(d3.group(chartData, d => d.cyl))
        .join("g")
          .attr("transform", d => `translate(${x0(d[0])},0)`)
        .selectAll("rect")
        .data(d => d[1])
        .join("rect")
          .attr("x", d => x1(d.type))
          .attr("y", d => y(d.value))
          .attr("width", x1.bandwidth())
          .attr("height", d => y(0) - y(d.value))
          .attr("fill", d => color(d.type));
    
      const legend = svg.append("g")
        .attr("transform", `translate(${width - margin.right + 20}, ${margin.top})`);
    
      ["City MPG", "Highway MPG"].forEach((type, i) => {
        const legendRow = legend.append("g").attr("transform", `translate(0, ${i * 20})`);
        legendRow.append("rect")
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", color(type));
        legendRow.append("text")
          .attr("x", 20)
          .attr("y", 12)
          .text(type)
          .attr("font-size", "12px")
          .attr("alignment-baseline", "middle");
      });
    }



    // function drawScene2() {
    //   const svg = d3.select("#vis")
    //     .append("svg")
    //     .attr("width", width)
    //     .attr("height", height);

    //   const x = d3.scaleLinear().domain([2, 14]).range([margin.left, width - margin.right]);
    //   const y = d3.scaleLinear().domain([10, 40]).range([height - margin.bottom, margin.top]);

    //   svg.append("g")
    //     .attr("transform", `translate(0,${height - margin.bottom})`)
    //     .call(d3.axisBottom(x).ticks(6).tickFormat(d3.format("d")));

    //   svg.append("g")
    //     .attr("transform", `translate(${margin.left},0)`)
    //     .call(d3.axisLeft(y));

    //   svg.selectAll("circle")
    //     .data(data)
    //     .join("circle")
    //     .attr("cx", d => x(d.EngineCylinders))
    //     .attr("cy", d => y(d.AverageHighwayMPG))
    //     .attr("r", 5)
    //     .attr("fill", "orange");

    //   svg.append("text")
    //     .attr("x", width / 2)
    //     .attr("y", margin.top)
    //     .attr("text-anchor", "middle")
    //     .attr("class", "annotation")
    //     .text("Higher cylinder count tends to reduce highway efficiency.");
    // }

    function drawScene2() {
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.AverageCityMPG))
        .nice()
        .range([margin.left, width - margin.right]);
    
      const y = d3.scaleLinear()
        .domain(d3.extent(data, d => d.AverageHighwayMPG))
        .nice()
        .range([height - margin.bottom, margin.top]);
    
      const uniqueCylinders = Array.from(new Set(data.map(d => d.EngineCylinders))).sort((a, b) => a - b);
    
      const color = d3.scaleOrdinal()
        .domain(uniqueCylinders)
        .range(d3.schemeCategory10);
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));
    
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height - 10)
        .attr("text-anchor", "middle")
        .text("Average City MPG");
    
      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", 20)
        .attr("text-anchor", "middle")
        .text("Average Highway MPG");
    
      svg.selectAll("circle")
        .data(data)
        .join("circle")
        .attr("cx", d => x(d.AverageCityMPG))
        .attr("cy", d => y(d.AverageHighwayMPG))
        .attr("r", 5)
        .attr("fill", d => color(d.EngineCylinders))
        .attr("opacity", 0.7);
    
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("class", "annotation")
        .text("City vs Highway MPG colored by engine cylinder count.");
    
      const legend = svg.selectAll(".legend")
        .data(uniqueCylinders)
        .join("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => `translate(0,${margin.top + i * 20})`);
    
      legend.append("rect")
        .attr("x", width - margin.right + 10)
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", d => color(d));
    
      legend.append("text")
        .attr("x", width - margin.right)
        .attr("y", 6)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .text(d => `${d} cylinders`);
    }

    function drawScene3() {
      updateScene3();
    }

    function updateScene3() {
      d3.select("#vis").html("");
      const selectedMake = d3.select("#makeSelector").property("value");
      const filtered = data.filter(d => d.Make === selectedMake);
    
      if (filtered.length === 0) return;
    
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
      const mpgTypes = ["AverageCityMPG", "AverageHighwayMPG"];
    
      // Compute average
      const averages = mpgTypes.map(mpgType => ({
        type: mpgType,
        value: d3.mean(filtered, d => d[mpgType])
      }));
    
      const x = d3.scaleBand()
        .domain(mpgTypes)
        .range([margin.left, width - margin.right])
        .padding(0.4);
    
      const y = d3.scaleLinear()
        .domain([0, d3.max(averages, d => d.value)])
        .nice()
        .range([height - margin.bottom, margin.top]);
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).tickFormat(d => d.replace("Average", "").replace("MPG", " MPG")));
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));
    
      svg.selectAll("rect")
        .data(averages)
        .join("rect")
        .attr("x", d => x(d.type))
        .attr("y", d => y(d.value))
        .attr("width", x.bandwidth())
        .attr("height", d => y(0) - y(d.value))
        .attr("fill", d => d.type === "AverageCityMPG" ? "teal" : "purple");
    
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top)
        .attr("text-anchor", "middle")
        .attr("class", "annotation")
        .text("City and highway MPG vary between models from the same manufacturer.");
    }

  </script>

</body>
</html>
