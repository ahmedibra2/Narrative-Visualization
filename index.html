<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2017 Auto MPG Narrative</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    #buttons {
      margin: 20px;
    }
    svg {
      margin-top: 20px;
    }
    .annotation {
      font-size: 14px;
      fill: #333;
      font-style: italic;
    }
  </style>
</head>
<body>

  <h1>2017 Automobile Efficiency Story</h1>

  <div id="buttons">
    <button onclick="setScene(1)">Scene 1: MPG Overview</button>
    <button onclick="setScene(2)">Scene 2: Cylinders vs MPG</button>
    <button onclick="setScene(3)">Scene 3: Make Comparison</button>
  </div>

  <select id="makeSelector" style="display:none;" onchange="updateScene3()"></select>

  <div id="vis"></div>
  <div id="tooltip" style="position: absolute; visibility: hidden; padding: 8px; background: #333; color: white; border-radius: 4px; font-size: 12px;"></div>


  <script>
    let data = [];
    const width = 1000, height = 600, margin = { top: 50, right: 180, bottom: 80, left: 80 };
    let currentScene = 1;
    const tooltip = d3.select("#tooltip");


    d3.csv("cars2017.csv").then(function(loadedData) {
      data = loadedData;
    
      data.forEach(function(d) {
        d.AverageHighwayMPG = +d.AverageHighwayMPG;
        d.AverageCityMPG = +d.AverageCityMPG;
        d.EngineCylinders = +d.EngineCylinders;
      });
        
      populateMakeSelector();
      setScene(1);
    }).catch(function(error) {
      console.error("Error loading the CSV:", error);
    });

    function populateMakeSelector() {
      const selector = d3.select("#makeSelector");
      const makes = Array.from(new Set(data.map(d => d.Make))).sort();
      selector.selectAll("option")
        .data(makes)
        .join("option")
        .text(d => d)
        .attr("value", d => d);
    
      selector.property("value", makes[0]);
    }

    function setScene(sceneNumber) {
      currentScene = sceneNumber;
      d3.select("#vis").html("");
      d3.select("#makeSelector").style("display", sceneNumber === 3 ? "inline" : "none");
      if (sceneNumber === 1) drawScene1();
      else if (sceneNumber === 2) drawScene2();
      else if (sceneNumber === 3) drawScene3();
    }
    
    function drawScene1() {
      
      const grouped = d3.rollups(
        data.filter(d => !isNaN(d.EngineCylinders)),
        v => ({
          avgCity: d3.mean(v, d => d.AverageCityMPG),
          avgHighway: d3.mean(v, d => d.AverageHighwayMPG)
        }),
        d => d.EngineCylinders
      );
    
      grouped.sort((a, b) => a[0] - b[0]);
    
      const engineGroups = grouped.map(d => d[0]);
      const avgCity = grouped.map(d => d[1].avgCity);
      const avgHighway = grouped.map(d => d[1].avgHighway);
    
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
      const x0 = d3.scaleBand()
        .domain(engineGroups)
        .range([margin.left, width - margin.right])
        .paddingInner(0.2);
    
      const x1 = d3.scaleBand()
        .domain(["City", "Highway"])
        .range([0, x0.bandwidth()])
        .padding(0.1);
    
      const y = d3.scaleLinear()
        .domain([0, d3.max([...avgCity, ...avgHighway])])
        .nice()
        .range([height - margin.bottom, margin.top]);
    
      const color = d3.scaleOrdinal()
        .domain(["City", "Highway"])
        .range(["#1f77b4", "#ff7f0e"]);
    
      const bars = svg.append("g");
    
      bars.selectAll("g")
        .data(grouped)
        .join("g")
        .attr("transform", d => `translate(${x0(d[0])},0)`)
        .selectAll("rect")
        .data(d => [
          { type: "City", value: d[1].avgCity },
          { type: "Highway", value: d[1].avgHighway }
        ])
        .join("rect")
        .attr("x", d => x1(d.type))
        .attr("y", d => y(d.value))
        .attr("width", x1.bandwidth())
        .attr("height", d => y(0) - y(d.value))
        .attr("fill", d => color(d.type));
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x0).tickFormat(d => `${d} cyl`));
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(10));

      // Y-axis title
      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", 20)
        .attr("text-anchor", "middle")
        .text("Average MPG");
      
      // X-axis title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height - 30)
        .attr("text-anchor", "middle")
        .text("Number of Engine Cylinders");
      
      // Title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top / 2)
        .attr("text-anchor", "middle")
        .attr("font-size", "20px")
        .text("Average MPG by Engine Cylinders");

      // Explanation Paragraph
      svg.append("text")
        .attr("class", "annotation")
        .attr("x", width - margin.right - 50)
        .attr("y", height / 2 - 30)           
        .attr("text-anchor", "start")
        .selectAll("tspan")
        .data([
          "This chart shows that the average",
          "miles per gallon consumption of", 
          "vehicles decreases as the",
          "number of cylinders increases.",
          "Vehicles with zero cylinders are",
          "electric vehicles."
        ])
        .join("tspan")
        .attr("x", width - margin.right - 50)
        .attr("dy", "1.2em")                 
        .text(d => d);
    
      const legend = svg.append("g")
        .attr("transform", `translate(${width - margin.right + 20},${margin.top})`);
    
      ["City", "Highway"].forEach((key, i) => {
        const g = legend.append("g").attr("transform", `translate(0,${i * 25})`);
        g.append("rect")
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", color(key));
        g.append("text")
          .attr("x", 20)
          .attr("y", 12)
          .text(key + " MPG");
      });
    }

    function drawScene2() {
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.AverageCityMPG))
        .nice()
        .range([margin.left, width - margin.right]);
    
      const y = d3.scaleLinear()
        .domain(d3.extent(data, d => d.AverageHighwayMPG))
        .nice()
        .range([height - margin.bottom, margin.top]);
    
      const uniqueCylinders = Array.from(new Set(data.map(d => d.EngineCylinders))).sort((a, b) => a - b);
    
      const color = d3.scaleOrdinal()
        .domain(uniqueCylinders)
        .range(d3.schemeCategory10);
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));
    
      // X-axis title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height - 10)
        .attr("text-anchor", "middle")
        .text("Average City MPG");
    
      // Y-axis title
      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", 20)
        .attr("text-anchor", "middle")
        .text("Average Highway MPG");

      // Explanation Paragraph
      svg.append("text")
        .attr("class", "annotation")
        .attr("x", width - margin.right - 50)
        .attr("y", height / 2 - 100)           
        .attr("text-anchor", "start")
        .selectAll("tspan")
        .data([
          "This scatter plot illustrates",
          "the relation between average", 
          "mile per gallon in the city",
          "and on the highway using each",
          "indiviudal point of the data.",
          "Points are colored based on",
          "their number of engine cylinders."
        ])
        .join("tspan")
        .attr("x", width - margin.right - 50)
        .attr("dy", "1.2em")                 
        .text(d => d);
    
      svg.selectAll("circle")
        .data(data)
        .join("circle")
        .attr("cx", d => x(d.AverageCityMPG))
        .attr("cy", d => y(d.AverageHighwayMPG))
        .attr("r", 5)
        .attr("fill", d => color(d.EngineCylinders))
        .attr("opacity", 0.7)
        .on("mouseover", (event, d) => { // Tooltip
          tooltip.style("visibility", "visible")
                 .html(`City MPG: ${d.AverageCityMPG}<br>Highway MPG: ${d.AverageHighwayMPG}`);
        })
        .on("mousemove", event => {
          tooltip.style("top", (event.pageY - 10) + "px")
                 .style("left", (event.pageX + 10) + "px");
        })
        .on("mouseout", () => {
          tooltip.style("visibility", "hidden");
        });

      // Title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top / 2)
        .attr("text-anchor", "middle")
        .attr("font-size", "20px")
        .text("City vs Highway MPG colored by engine cylinder count.");
    
      const legend = svg.selectAll(".legend")
        .data(uniqueCylinders)
        .join("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => `translate(0,${height - margin.bottom - uniqueCylinders.length * 20 + i * 20})`);
    
      legend.append("rect")
        .attr("x", width - margin.right + 10)
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", d => color(d));
    
      legend.append("text")
        .attr("x", width - margin.right)
        .attr("y", 10)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .text(d => `${d} cylinders`);
    }

    function drawScene3() {
      updateScene3();
    }

    function updateScene3() {
      d3.select("#vis").html("");
      const selectedMake = d3.select("#makeSelector").property("value");
      const filtered = data.filter(d => d.Make === selectedMake);
    
      if (filtered.length === 0) return;
    
      const svg = d3.select("#vis")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
      const mpgTypes = ["AverageCityMPG", "AverageHighwayMPG"];
    
      const averages = mpgTypes.map(mpgType => ({
        type: mpgType,
        value: d3.mean(filtered, d => d[mpgType])
      }));
    
      const x = d3.scaleBand()
        .domain(mpgTypes)
        .range([margin.left, width - margin.right])
        .padding(0.4);
    
      const y = d3.scaleLinear()
        .domain([0, d3.max(averages, d => d.value)])
        .nice()
        .range([height - margin.bottom, margin.top]);
    
      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).tickFormat(d => d.replace("Average", "").replace("MPG", " MPG")));
    
      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      // Y-axis title
      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", 20)
        .attr("text-anchor", "middle")
        .text("Average MPG");

      // Explanation Paragraph
      svg.append("text")
        .attr("class", "annotation")
        .attr("x", width - margin.right - 50)
        .attr("y", height / 2 - 30)           
        .attr("text-anchor", "start")
        .selectAll("tspan")
        .data([
          "This bar plot compares the",
          "average milage per gallon", 
          "in the city and on the highway",
          "for each vehicle make. Use the",
          "drop-down menu to select the",
          "vehicle make to see its MPG."
        ])
        .join("tspan")
        .attr("x", width - margin.right - 50)
        .attr("dy", "1.2em")                 
        .text(d => d);
    
      svg.selectAll("rect")
        .data(averages)
        .join("rect")
        .attr("x", d => x(d.type))
        .attr("y", d => y(d.value))
        .attr("width", x.bandwidth())
        .attr("height", d => y(0) - y(d.value))
        .attr("fill", d => d.type === "AverageCityMPG" ? "teal" : "purple")
        .on("mouseover", (event, d) => { // Tooltip
            const label = d.type === "AverageCityMPG" ? "City MPG" : "Highway MPG";
            tooltip.style("visibility", "visible")
                   .text(`${label}: ${d.value.toFixed(1)}`);
          })
          .on("mousemove", event => {
            tooltip.style("top", (event.pageY - 10) + "px")
                   .style("left", (event.pageX + 10) + "px");
          })
          .on("mouseout", () => {
            tooltip.style("visibility", "hidden");
        });

      // Title
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top / 2)
        .attr("text-anchor", "middle")
        .attr("font-size", "20px")
        .text("City and highway MPG vary between models from the same manufacturer.");
      
    }

  </script>

</body>
</html>
